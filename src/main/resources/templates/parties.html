<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>파티원 모집</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/document/css/layout.css}" />
    <link rel="stylesheet" th:href="@{/document/css/parties.css}" />
</head>
<body>

<!-- 헤더 -->
<div th:replace="~{fragments/header :: header}"></div>

<!-- 컨텐츠 -->
<div class="container mt-4">

    <!-- 제목 -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="page-title text-center w-100">파티원 모집</h1>
    </div>

    <!-- 탭 + 글쓰기 버튼 -->
    <div class="d-flex justify-content-between align-items-center mb-4 tab-header">
        <div class="tab-menu">
            <a th:href="@{/parties(category='delivery')}" th:classappend="${category} == 'delivery' ? ' active' : ''" class="tab">배달</a>
            <a th:href="@{/parties(category='dine-out')}" th:classappend="${category} == 'dine-out' ? ' active' : ''" class="tab">외식</a>
            <a th:href="@{/parties(category='lunchbox')}" th:classappend="${category} == 'lunchbox' ? ' active' : ''" class="tab">도시락</a>
            <a th:href="@{/parties(category='betting')}" th:classappend="${category} == 'betting' ? ' active' : ''" class="tab">내기</a>
        </div>
        <button class="btn btn-write" data-bs-toggle="modal" data-bs-target="#createPartyModal">글쓰기</button>
    </div>

    <!-- 파티 카드 목록 -->
    <div class="tab-content">
        <ul class="list-unstyled" id="party-list">
            <li th:each="party : ${parties}" class="party-card">
                <a th:href="@{'/parties/' + ${party.id}}" class="card-link">
                    <h5 th:text="${party.title}"></h5>
                    <p>
                        참여 인원: <span th:text="${party.currentPeople}"></span> / <span th:text="${party.limitPeople}"></span><br />
                        마감 시간: <span th:text="${#dates.format(party.finishedAt, 'yyyy-MM-dd HH:mm')}"></span><br />
                        <span th:if="${party.limitPrice > 0}">최소 주문 금액: <span th:text="${party.limitPrice}"></span>원</span><br />
                        <span th:unless="${party.isOpen}" class="closed-party">(마감)</span>
                    </p>
                </a>
            </li>
        </ul>
    </div>
</div>

<!-- 모달 삽입 -->
<div th:replace="~{fragments/create-party-modal :: createPartyModal}"></div>

<!-- 푸터 -->
<div th:replace="~{fragments/footer :: footer}"></div>

<!-- 스크립트 -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.getElementById('create-party-form')?.addEventListener('submit', async function (e) {
        e.preventDefault();

        const form = e.target;
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        try {
            const response = await fetch('/party/create', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });

            if (!response.ok) throw new Error('서버 오류');

            const party = await response.json();

            const li = document.createElement('li');
            li.className = 'party-card';
            li.innerHTML = `
      <a href="/parties/${party.id}" class="card-link">
        <h5>${party.title}</h5>
        <p>
          참여 인원: ${party.currentPeople} / ${party.limitPeople}<br />
          마감 시간: ${new Date(party.finishedAt).toLocaleString()}<br />
          ${party.limitPrice > 0 ? `최소 주문 금액: ${party.limitPrice}원<br />` : ''}
          ${!party.isOpen ? '<span class="closed-party">(마감)</span>' : ''}
        </p>
      </a>
    `;
            document.getElementById('party-list').prepend(li);

            bootstrap.Modal.getInstance(document.getElementById('createPartyModal')).hide();
            form.reset();

        } catch (err) {
            alert('파티 생성 중 오류 발생');
            console.error(err);
        }
    });
</script>

</body>
</html>