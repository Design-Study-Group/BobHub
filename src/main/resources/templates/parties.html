<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>파티원 모집</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/document/css/layout.css}" />
    <link rel="stylesheet" th:href="@{/document/css/parties.css}" />
</head>
<body>

<!-- 헤더 -->
<div th:replace="~{fragments/header :: header}"></div>

<!-- 컨텐츠 -->
<div class="container mt-4">

    <!-- 제목 -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="page-title text-center w-100">파티원 모집</h1>
    </div>

    <!-- 탭 + 글쓰기 버튼 -->
    <div class="d-flex justify-content-between align-items-center mb-4 tab-header">
        <div class="tab-menu">
            <a th:href="@{/parties(category='delivery')}" th:classappend="${category} == 'delivery' ? ' active' : ''" class="tab">배달</a>
            <a th:href="@{/parties(category='dine_out')}" th:classappend="${category} == 'dine_out' ? ' active' : ''" class="tab">외식</a>
            <a th:href="@{/parties(category='lunchbox')}" th:classappend="${category} == 'lunchbox' ? ' active' : ''" class="tab">도시락</a>
            <a th:href="@{/parties(category='betting')}" th:classappend="${category} == 'betting' ? ' active' : ''" class="tab">내기</a>
        </div>
        <button class="btn btn-write" data-bs-toggle="modal" data-bs-target="#createPartyModal">글쓰기</button>
    </div>

    <!-- 파티 카드 목록 -->
    <ul class="list-unstyled d-flex flex-wrap gap-3" id="party-list">
        <li th:each="party : ${parties}"
            th:if="${party.finishedAt.isAfter(T(java.time.LocalDateTime).now())}"
            class="party-card">
            <a th:href="@{'/parties/' + ${party.id} + '/comments'}" class="card-link">
                <h5 th:text="${party.title}">파티 제목</h5>
                <p>
                    참여 인원:
                    <span th:text="${party.currentPeople}"></span> /
                    <span th:text="${party.limitPeople}"></span><br/>

                    <span th:if="${party.limitPrice > 0}">
                    최소 주문 금액:
                    <span th:text="${party.limitPrice}"></span>원<br/><br/>

                    </span>
                        <span class="remaining-time"
                              th:attr="data-finished-at=${party.finishedAt}">
                        <!-- JS에서 계산 -->
                    </span>
                </p>
            </a>
        </li>
    </ul>
</div>

<!-- 모달 삽입 -->
<div th:replace="~{fragments/create-party-modal :: createPartyModal}"></div>

<!-- 푸터 -->
<div th:replace="~{fragments/footer :: footer}"></div>

<!-- 스크립트 -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // 날짜 포맷 함수: MM월 dd일 HH시 mm분까지
    function formatRemainingTime(end) {
        const now = new Date();
        const diff = end.getTime() - now.getTime();

        if (diff <= 0) return null;

        const totalMinutes = Math.floor(diff / 1000 / 60);
        const days = Math.floor(totalMinutes / 1440);
        const hours = Math.floor((totalMinutes % 1440) / 60);
        const minutes = totalMinutes % 60;

        let result = '';
        if (days > 0) result += `${days}일 `;
        if (hours > 0) result += `${hours}시간 `;
        result += `${minutes}분 남음`;

        return result;
    }

    function updateRemainingTimes() {
        const now = new Date();
        document.querySelectorAll('.remaining-time').forEach(el => {
            const end = new Date(el.dataset.finishedAt);
            if (end <= now) {
                el.closest('.party-card')?.remove();
                return;
            }

            const text = formatRemainingTime(end);
            el.innerText = text;
        });
    }

    updateRemainingTimes();
    setInterval(updateRemainingTimes, 60000);
</script>

</body>
</html>
